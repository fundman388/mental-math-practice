<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>速算狀元每日訓練題 (含小數)</title>
    <!-- Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM (核心框架) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (讓瀏覽器看不懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 字體設定：優先使用 Apple San Francisco */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* 列印專用樣式 */
        @media print {
            /* 設定頁面邊距 */
            @page { margin: 0.5cm; size: A4; }
            body { -webkit-print-color-adjust: exact; background-color: white; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- React 應用程式掛載點 -->
    <div id="root"></div>

    <script type="text/babel">
        // 從全域 React 物件中解構需要的 hook
        const { useState, useEffect } = React;

        // 定義 Facebook Blue 顏色變數
        const FB_BLUE = '#1877F2';

        // --- 圖示組件 (SVG) ---
        const PrinterIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
        );
        const RefreshCwIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
        );
        const EyeIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        );
        const EyeOffIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
        );
        const SettingsIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l-.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        );

        const AbacusGenerator = () => {
            const [config, setConfig] = useState({
                type: 'addsub', // addsub, mul, div
                digits: 2,      // 位數 (加減算為數字位數，乘除為被乘/除數位數)
                digits2: 2,     // 乘數/除數位數
                decimals: 0,    // 小數位數 (0, 1, 2)
                rows: 5,        // 口數
                count: 20,      // 題數
                allowNegative: true, // 包含減法
                ensurePositiveResult: true // 結果為正
            });

            const [problems, setProblems] = useState([]);
            const [showAnswers, setShowAnswers] = useState(false);
            const [paperTitle, setPaperTitle] = useState('速算狀元每日訓練');

            // 輔助函數：解決浮點數運算誤差
            const fixMath = (num) => {
                return parseFloat(num.toFixed(10));
            };

            // 輔助函數：生成指定位數和小數位數的隨機數
            const generateNumber = (digitCount, decimalCount) => {
                // 整數部分
                const min = Math.pow(10, digitCount - 1);
                const max = Math.pow(10, digitCount) - 1;
                const intPart = Math.floor(Math.random() * (max - min + 1)) + min;
                
                if (decimalCount === 0) return intPart;

                // 小數部分 (例如 2位小數 => 00~99)
                const maxDec = Math.pow(10, decimalCount);
                const decPart = Math.floor(Math.random() * maxDec);
                
                // 組合字串再轉回數字，確保精確
                return parseFloat(`${intPart}.${decPart.toString().padStart(decimalCount, '0')}`);
            };

            // 生成題目的邏輯
            const generateProblems = () => {
                const newProblems = [];
                for (let i = 0; i < config.count; i++) {
                    let problem = {};

                    if (config.type === 'addsub') {
                        let numbers = [];
                        let sum = 0;
                        let attempts = 0;
                        
                        while (true) {
                            numbers = [];
                            sum = 0;
                            let currentSum = 0;

                            for (let r = 0; r < config.rows; r++) {
                                let num = generateNumber(config.digits, config.decimals);
                                
                                let isNegative = false;
                                if (r > 0 && config.allowNegative) {
                                    isNegative = Math.random() > 0.5;
                                }

                                if (isNegative) num = -num;

                                numbers.push(num);
                                currentSum = fixMath(currentSum + num);
                            }

                            if (config.ensurePositiveResult && currentSum < 0) {
                                attempts++;
                                if (attempts > 20) {
                                    // 強制修正第一題使其夠大
                                    const diff = Math.abs(currentSum) + generateNumber(config.digits, config.decimals);
                                    numbers[0] = fixMath(numbers[0] + diff);
                                    currentSum = fixMath(currentSum + diff);
                                    sum = currentSum;
                                    break;
                                }
                                continue;
                            }
                            sum = currentSum;
                            break;
                        }
                        
                        // 格式化數字顯示 (補齊小數位)
                        const formattedContent = numbers.map(n => 
                            config.decimals > 0 ? n.toFixed(config.decimals) : n.toString()
                        );

                        problem = {
                            id: i,
                            content: formattedContent,
                            answer: config.decimals > 0 ? sum.toFixed(config.decimals) : sum
                        };

                    } else if (config.type === 'mul') {
                        const num1 = generateNumber(config.digits, config.decimals);
                        const num2 = generateNumber(config.digits2, config.decimals);
                        const product = fixMath(num1 * num2);

                        // 計算總小數位數，用於顯示答案
                        const totalDecimals = config.decimals * 2;
                        
                        problem = {
                            id: i,
                            content: [num1, num2],
                            display: `${config.decimals > 0 ? num1.toFixed(config.decimals) : num1} × ${config.decimals > 0 ? num2.toFixed(config.decimals) : num2} =`,
                            answer: config.decimals > 0 ? product.toFixed(totalDecimals).replace(/\.?0+$/, "") : product // 去除多餘的0，或保留
                        };
                        // 乘法答案保留合適的小數位
                        problem.answer = config.decimals > 0 ? product.toFixed(totalDecimals) : product;


                    } else if (config.type === 'div') {
                        // 除法邏輯反轉：先產生商(Quotient)和除數(Divisor)，算出被除數(Dividend)
                        // 這樣可以保證除得盡
                        
                        // 商的位數 (假設與設定的"被除數位數"相關，這裡簡化為 digits)
                        // 為了難度，讓商的位數與被除數設定相近
                        const quotient = generateNumber(Math.max(1, config.digits - config.digits2 + 1), config.decimals);
                        const divisor = generateNumber(config.digits2, config.decimals);
                        
                        const dividend = fixMath(quotient * divisor);
                        
                        // 格式化顯示
                        const displayDivisor = config.decimals > 0 ? divisor.toFixed(config.decimals) : divisor;
                        // 被除數的小數位數可能較多，需要完整顯示
                        const dividendDecimals = (dividend.toString().split('.')[1] || '').length;
                        const displayDividend = dividend.toFixed(dividendDecimals);

                        problem = {
                            id: i,
                            content: [dividend, divisor],
                            display: `${displayDividend} ÷ ${displayDivisor} =`,
                            answer: config.decimals > 0 ? quotient.toFixed(config.decimals) : quotient
                        };
                    }

                    newProblems.push(problem);
                }
                setProblems(newProblems);
            };

            useEffect(() => {
                generateProblems();
            }, []);

            // 列印功能
            const handlePrint = () => {
                setTimeout(() => {
                    window.print();
                }, 100);
            };

            const setPreset = (name) => {
                if (name === 'level10') {
                    setConfig({...config, type: 'addsub', digits: 1, rows: 3, decimals: 0, allowNegative: false});
                    setPaperTitle('珠心算入門練習 (10級)');
                } else if (name === 'level8') {
                    setConfig({...config, type: 'addsub', digits: 2, rows: 3, decimals: 0, allowNegative: true});
                    setPaperTitle('珠心算基礎練習 (8級)');
                } else if (name === 'level5') {
                    setConfig({...config, type: 'addsub', digits: 3, rows: 5, decimals: 0, allowNegative: true});
                    setPaperTitle('珠心算進階練習 (5級)');
                } else if (name === 'decimal_add') {
                    setConfig({...config, type: 'addsub', digits: 2, rows: 5, decimals: 2, allowNegative: true});
                    setPaperTitle('小數加減特訓 (2位小數)');
                } else if (name === 'decimal_mul') {
                    setConfig({...config, type: 'mul', digits: 2, digits2: 2, decimals: 1});
                    setPaperTitle('小數乘法特訓 (1位小數)');
                } else if (name === 'decimal_div') {
                    setConfig({...config, type: 'div', digits: 3, digits2: 2, decimals: 1});
                    setPaperTitle('小數除法特訓');
                }
            };

            return (
                <div className="max-w-5xl mx-auto p-4 md:p-8 print:p-0">
                    
                    {/* Control Panel: 增加 z-index 確保點擊有效 */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8 print:hidden no-print relative z-50">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <h1 className="text-2xl font-bold flex items-center gap-2" style={{ color: FB_BLUE }}>
                                <SettingsIcon />
                                速算狀元每日訓練題
                            </h1>
                            <div className="flex gap-2 mt-4 md:mt-0 flex-wrap">
                                <button onClick={() => setShowAnswers(!showAnswers)} className="cursor-pointer flex items-center gap-2 px-4 py-2 text-sm font-medium text-white rounded-lg hover:opacity-90 transition-opacity" style={{ backgroundColor: '#718096' }}>
                                    {showAnswers ? <EyeOffIcon /> : <EyeIcon />}
                                    {showAnswers ? '隱藏答案' : '顯示答案'}
                                </button>
                                <button onClick={generateProblems} className="cursor-pointer flex items-center gap-2 px-4 py-2 text-sm font-medium text-white rounded-lg hover:opacity-90 transition-opacity shadow-sm" style={{ backgroundColor: FB_BLUE }}>
                                    <RefreshCwIcon />
                                    重新生成
                                </button>
                                <button onClick={handlePrint} className="cursor-pointer flex items-center gap-2 px-4 py-2 text-sm font-medium text-white rounded-lg hover:opacity-90 transition-opacity shadow-sm" style={{ backgroundColor: '#059669' }}>
                                    <PrinterIcon />
                                    列印題目
                                </button>
                            </div>
                        </div>

                        {/* Presets */}
                        <div className="mb-6 pb-6 border-b border-gray-100">
                            <span className="text-sm font-semibold text-gray-500 mr-2">快速預設：</span>
                            <div className="inline-flex flex-wrap gap-2">
                                <button onClick={() => setPreset('level10')} className="px-3 py-1 text-xs rounded-full border hover:bg-blue-50 transition-colors" style={{ color: FB_BLUE, borderColor: FB_BLUE }}>入門 (1位3口)</button>
                                <button onClick={() => setPreset('level8')} className="px-3 py-1 text-xs rounded-full border hover:bg-blue-50 transition-colors" style={{ color: FB_BLUE, borderColor: FB_BLUE }}>初級 (2位3口)</button>
                                <button onClick={() => setPreset('level5')} className="px-3 py-1 text-xs rounded-full border hover:bg-blue-50 transition-colors" style={{ color: FB_BLUE, borderColor: FB_BLUE }}>中級 (3位5口)</button>
                                <div className="w-px h-6 bg-gray-300 mx-1"></div>
                                <button onClick={() => setPreset('decimal_add')} className="px-3 py-1 text-xs rounded-full border hover:bg-indigo-50 transition-colors" style={{ color: '#1e3a8a', borderColor: '#1e3a8a' }}>小數加減</button>
                                <button onClick={() => setPreset('decimal_mul')} className="px-3 py-1 text-xs rounded-full border hover:bg-indigo-50 transition-colors" style={{ color: '#1e3a8a', borderColor: '#1e3a8a' }}>小數乘法</button>
                                <button onClick={() => setPreset('decimal_div')} className="px-3 py-1 text-xs rounded-full border hover:bg-indigo-50 transition-colors" style={{ color: '#1e3a8a', borderColor: '#1e3a8a' }}>小數除法</button>
                            </div>
                        </div>

                        {/* Config */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700">運算類型</label>
                                <select 
                                    value={config.type} 
                                    onChange={(e) => setConfig({...config, type: e.target.value})}
                                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 outline-none"
                                    style={{ borderColor: '#e5e7eb', color: FB_BLUE }}
                                >
                                    <option value="addsub">加減算 (直式)</option>
                                    <option value="mul">乘法 (橫式)</option>
                                    <option value="div">除法 (橫式)</option>
                                </select>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700">小數位 (Decimal places)</label>
                                <select 
                                    value={config.decimals} 
                                    onChange={(e) => setConfig({...config, decimals: parseInt(e.target.value)})}
                                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 outline-none font-medium"
                                    style={{ borderColor: '#e5e7eb', color: FB_BLUE }}
                                >
                                    <option value="0">整數 (無小數)</option>
                                    <option value="1">1位小數 (.x)</option>
                                    <option value="2">2位小數 (.xx)</option>
                                </select>
                            </div>

                            {config.type === 'addsub' ? (
                                <>
                                    <div className="space-y-2">
                                        <label className="text-sm font-semibold text-gray-700">整數位數 (Digits)</label>
                                        <input 
                                            type="number" min="1" max="6"
                                            value={config.digits}
                                            onChange={(e) => setConfig({...config, digits: parseInt(e.target.value) || 1})}
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            style={{ color: FB_BLUE }}
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-semibold text-gray-700">口數 (Rows)</label>
                                        <input 
                                            type="number" min="2" max="20"
                                            value={config.rows}
                                            onChange={(e) => setConfig({...config, rows: parseInt(e.target.value) || 3})}
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            style={{ color: FB_BLUE }}
                                        />
                                    </div>
                                    <div className="md:col-span-4 flex flex-row items-center gap-6 mt-2">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                checked={config.allowNegative}
                                                onChange={(e) => setConfig({...config, allowNegative: e.target.checked})}
                                                className="w-4 h-4 rounded"
                                                style={{ color: FB_BLUE }}
                                            />
                                            <span className="text-sm text-gray-700">包含減法</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                checked={config.ensurePositiveResult}
                                                onChange={(e) => setConfig({...config, ensurePositiveResult: e.target.checked})}
                                                className="w-4 h-4 rounded"
                                                style={{ color: FB_BLUE }}
                                            />
                                            <span className="text-sm text-gray-700">答案必為正數</span>
                                        </label>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div className="space-y-2">
                                        <label className="text-sm font-semibold text-gray-700">
                                            {config.type === 'mul' ? '被乘數' : '被除數'}整數位 (Digits)
                                        </label>
                                        <input 
                                            type="number" min="1" max="6"
                                            value={config.digits}
                                            onChange={(e) => setConfig({...config, digits: parseInt(e.target.value) || 1})}
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            style={{ color: FB_BLUE }}
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-semibold text-gray-700">
                                            {config.type === 'mul' ? '乘數' : '除數'}整數位 (Digits)
                                        </label>
                                        <input 
                                            type="number" min="1" max="6"
                                            value={config.digits2}
                                            onChange={(e) => setConfig({...config, digits2: parseInt(e.target.value) || 1})}
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            style={{ color: FB_BLUE }}
                                        />
                                    </div>
                                </>
                            )}

                            <div className="space-y-2 md:col-span-4 mt-2 border-t pt-4 border-gray-100 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="text-sm font-semibold text-gray-700">卷頭標題</label>
                                    <input 
                                        type="text"
                                        value={paperTitle}
                                        onChange={(e) => setPaperTitle(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-md"
                                        style={{ color: FB_BLUE }}
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-semibold text-gray-700">題目數量</label>
                                    <select 
                                        value={config.count}
                                        onChange={(e) => setConfig({...config, count: parseInt(e.target.value)})}
                                        className="w-full p-2 border border-gray-300 rounded-md"
                                        style={{ color: FB_BLUE }}
                                    >
                                        <option value="10">10 題 (半頁)</option>
                                        <option value="20">20 題 (標準)</option>
                                        <option value="30">30 題 (密集)</option>
                                        <option value="50">50 題 (極限)</option>
                                        <option value="100">100 題 (多頁)</option>
                                        <option value="200">200 題 (挑戰)</option>
                                        <option value="400">400 題 (馬拉松)</option>
                                        <option value="800">800 題 (超級馬拉松)</option>
                                        <option value="1000">1000 題 (神級挑戰)</option>
                                        <option value="1500">1500 題 (宇宙級挑戰)</option>
                                        <option value="2000">2000 題 (終極挑戰)</option>
                                        <option value="3000">3000 題 (極限挑戰)</option>
                                        <option value="4000">4000 題 (超神挑戰)</option>
                                        <option value="5000">5000 題 (傳說挑戰)</option>
                                        <option value="6000">6000 題 (無限挑戰)</option>
                                        <option value="7000">7000 題 (奇蹟挑戰)</option>
                                        <option value="8000">8000 題 (世界紀錄)</option>
                                        <option value="9000">9000 題 (突破天際)</option>
                                        <option value="10000">10000 題 (萬題斬)</option>
                                        <option value="11000">11000 題 (傳奇再臨)</option>
                                        <option value="12000">12000 題 (巔峰造極)</option>
                                        <option value="13000">13000 題 (超凡入聖)</option>
                                        <option value="14000">14000 題 (究極運算)</option>
                                        <option value="15000">15000 題 (神話降臨)</option>
                                        <option value="16000">16000 題 (不可思議)</option>
                                        <option value="17000">17000 題 (超越極限)</option>
                                        <option value="18000">18000 題 (算神降臨)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Paper Area - A4 Size Container */}
                    <div className="bg-white p-8 shadow-lg min-h-[29.7cm] print:shadow-none print:w-full print:p-0 relative overflow-hidden print:overflow-visible text-[#1877F2]">
                        
                        {/* 內框 (Frame) - 模擬附件設計。 修改：m-0 (0px)，完全貼邊，避免遮擋內容 */}
                        <div className="absolute inset-0 m-0 border-4 rounded-3xl pointer-events-none z-20 print:fixed print:inset-0 print:m-0" style={{ borderColor: FB_BLUE }}></div>

                        {/* Watermark: 使用 z-50 確保在每頁最上層顯示 (Overlay) */}
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none select-none z-0 print:fixed print:inset-0 print:flex print:items-center print:justify-center print:z-50">
                            <div className="text-center transform -rotate-45" style={{ color: FB_BLUE, opacity: 0.18 }}>
                                <div className="text-3xl md:text-5xl font-black tracking-wider whitespace-nowrap">Hong Kong Mental Math Academy</div>
                                <div className="text-xl md:text-2xl font-bold mt-4 tracking-widest">www.hkmma.org</div>
                            </div>
                        </div>

                        {/* 題目內容區: 使用 z-10 確保在浮水印之上(螢幕顯示時)，列印時浮水印會在更上層 */}
                        <div className="relative z-10 px-4 py-6">
                            <div className="text-center mb-8 border-b-2 pb-4" style={{ borderColor: FB_BLUE }}>
                                <h2 className="text-3xl font-bold mb-2" style={{ color: FB_BLUE }}>{paperTitle}</h2>
                                <div className="flex justify-between text-sm mt-4 px-4 font-semibold" style={{ color: FB_BLUE }}>
                                    <span>姓名：_________________</span>
                                    <span>日期：________年____月____日</span>
                                    <span>分數：__________</span>
                                </div>
                                <div className="text-xs mt-2 print:hidden no-print" style={{ color: FB_BLUE, opacity: 0.7 }}>
                                    設定：{config.type === 'addsub' ? `加減算 / ${config.digits}位整數${config.decimals > 0 ? ` + ${config.decimals}位小數` : ''} / ${config.rows}口` : `${config.type === 'mul' ? '乘法' : '除法'} / 含${config.decimals}位小數`}
                                </div>
                            </div>

                            <div className={`grid gap-8 ${
                                config.type === 'addsub' 
                                    ? 'grid-cols-5 md:grid-cols-5 print:grid-cols-5' 
                                    : 'grid-cols-2 md:grid-cols-3 print:grid-cols-3'
                            }`}>
                                {problems.map((prob, idx) => (
                                    <div key={prob.id} className="break-inside-avoid">
                                        {config.type === 'addsub' && (
                                            /* 修改為 flex-col 並 items-center 確保垂直對齊 */
                                            <div className="flex flex-col items-center">
                                                {/* 題目編號 */}
                                                <div className="mb-2 font-bold text-xs" style={{ color: FB_BLUE, opacity: 0.7 }}>({idx + 1})</div>
                                                
                                                {/* 算式容器: items-end 確保小數點對齊 */}
                                                <div className="flex flex-col items-end" style={{ color: FB_BLUE }}>
                                                    {prob.content.map((numStr, rIdx) => (
                                                        <div key={rIdx} className="font-mono text-xl leading-relaxed whitespace-pre">
                                                            {numStr}
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="w-24 border-t-2 mt-1 mb-2" style={{ borderColor: FB_BLUE }}></div>
                                                {showAnswers && (
                                                    <div className="font-bold font-mono text-lg" style={{ color: FB_BLUE }}>{prob.answer}</div>
                                                )}
                                                {!showAnswers && (
                                                    <div className="h-8 w-24 border bg-blue-50 rounded" style={{ borderColor: '#bfdbfe' }}></div>
                                                )}
                                            </div>
                                        )}

                                        {(config.type === 'mul' || config.type === 'div') && (
                                            <div className="flex flex-col mb-4">
                                                <div className="flex items-baseline gap-2 mb-2">
                                                    <span className="font-bold text-xs w-6" style={{ color: FB_BLUE, opacity: 0.7 }}>({idx + 1})</span>
                                                    <span className="font-mono text-xl" style={{ color: FB_BLUE }}>{prob.display}</span>
                                                </div>
                                                <div className="flex items-center gap-2 pl-8">
                                                    {showAnswers ? (
                                                        <div className="font-bold font-mono text-lg border-b px-2 min-w-[60px] text-center" style={{ color: FB_BLUE, borderColor: FB_BLUE }}>
                                                            {prob.answer}
                                                        </div>
                                                    ) : (
                                                        <div className="h-8 w-32 border-b" style={{ borderColor: FB_BLUE }}></div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <div className="mt-12 text-center text-xs print:fixed print:bottom-4 print:left-0 print:w-full" style={{ color: FB_BLUE, opacity: 0.8 }}>
                                Powered by Hong Kong Mental Math Academy www.hkmma.org +852-64108146
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AbacusGenerator />);
    </script>
</body>
</html>
